<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人理財健檢與儲蓄計畫 - 專業顧問版</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 React 與 ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- 引入 Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        .progress-bar { transition: width 0.5s ease-in-out; }
        .sync-loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- 圖標組件 ---
        const IconWallet = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4"/><path d="M3 5v14a2 2 0 0 0 2 2h16v-5"/><path d="M18 12a2 2 0 0 0 0 4h4v-4Z"/></svg>
        );
        const IconTrendingUp = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>
        );
        const IconTrendingDown = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 17 13.5 8.5 8.5 13.5 2 7"/><polyline points="16 17 22 17 22 11"/></svg>
        );
        const IconPieChart = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
        );
        const IconAlertTriangle = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
        );
        const IconCheckCircle = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
        );
        const IconDollarSign = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        );
        const IconPlus = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        );
        const IconTrash = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
        );
        const IconChevronUp = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="18 15 12 9 6 15"/></svg>
        );
        const IconChevronDown = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="6 9 12 15 18 9"/></svg>
        );
        const IconSave = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        );
        const IconRefreshCw = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></svg>
        );
        const IconDownload = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
        );
        const IconUpload = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
        );
        const IconActivity = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
        );

        const FinancialPlanner = () => {
          const [activeTab, setActiveTab] = useState('dashboard');
          const [isSyncing, setIsSyncing] = useState(false);
          const fileInputRef = useRef(null);
          const [toastMessage, setToastMessage] = useState(null);
          
          // 0. 匯率狀態
          const [usdRate, setUsdRate] = useState(() => {
            const saved = localStorage.getItem('fp_usdRate');
            return saved !== null ? Number(saved) : 31.5;
          });

          // 1. 資產預設狀態
          const defaultAssets = {
            cashAccounts: [{ id: 1, name: '主要銀行存款', amount: 0 }],
            twStocks: [],
            usStocks: [],
            etfs: [],
            insurances: [{ id: 1, name: '儲蓄險 / 壽險', amount: 0, currency: 'TWD' }],
            fixedAssetsList: [{ id: 1, name: '房地產 / 汽機車', amount: 0 }]
          };

          const [assets, setAssets] = useState(() => {
            const saved = localStorage.getItem('fp_assets');
            return saved ? JSON.parse(saved) : defaultAssets;
          });

          // 2. 負債預設狀態
          const defaultLiabilities = {
            creditCards: [{ id: 1, name: '常用信用卡 (含分期)', amount: 0 }],
            loans: [{ id: 1, name: '一般貸款項目', amount: 0 }]
          };

          const [liabilities, setLiabilities] = useState(() => {
            const saved = localStorage.getItem('fp_liabilities');
            return saved ? JSON.parse(saved) : defaultLiabilities;
          });

          // 3. 現金流預設狀態
          const defaultCashFlow = {
            income: [
              { id: 1, name: '每月薪資 (實拿)', amount: 0 },
              { id: 2, name: '其他收入', amount: 0 }
            ],
            expenses: [
              { id: 1, name: '房租 / 房貸', amount: 0 },
              { id: 2, name: '生活費 (飲食/日用)', amount: 0 },
              { id: 3, name: '交通費', amount: 0 },
              { id: 4, name: '電信網路費', amount: 0 },
              { id: 5, name: '貸款月付金', amount: 0 }
            ]
          };

          const [cashFlow, setCashFlow] = useState(() => {
            const saved = localStorage.getItem('fp_cashFlow');
            return saved ? JSON.parse(saved) : defaultCashFlow;
          });

          // --- 自動儲存 ---
          useEffect(() => { localStorage.setItem('fp_usdRate', usdRate.toString()); }, [usdRate]);
          useEffect(() => { localStorage.setItem('fp_assets', JSON.stringify(assets)); }, [assets]);
          useEffect(() => { localStorage.setItem('fp_liabilities', JSON.stringify(liabilities)); }, [liabilities]);
          useEffect(() => { localStorage.setItem('fp_cashFlow', JSON.stringify(cashFlow)); }, [cashFlow]);

          // --- 核心計算邏輯 ---
          const calculations = useMemo(() => {
            const totalCash = assets.cashAccounts.reduce((sum, acc) => sum + acc.amount, 0);
            const twStockTotal = assets.twStocks.reduce((sum, stock) => sum + (stock.shares * stock.price), 0);
            const usStockTotalUSD = assets.usStocks.reduce((sum, stock) => sum + (stock.shares * stock.price), 0);
            const usStockTotalTWD = usStockTotalUSD * usdRate;
            const etfTotal = assets.etfs.reduce((sum, etf) => sum + (etf.shares * etf.price), 0);
            
            // 重要：修正保險與固定資產計算
            const insuranceTotalTWD = assets.insurances.reduce((sum, item) => sum + (item.currency === 'USD' ? item.amount * usdRate : item.amount), 0);
            const totalFixedAssets = assets.fixedAssetsList.reduce((sum, item) => sum + item.amount, 0);
            const insuranceAndFixedTotalTWD = insuranceTotalTWD + totalFixedAssets;

            const totalInvestments = twStockTotal + usStockTotalTWD + etfTotal + insuranceTotalTWD;
            const totalAssets = totalCash + totalInvestments + totalFixedAssets;

            const totalCreditCards = liabilities.creditCards.reduce((sum, item) => sum + item.amount, 0);
            const totalLoans = liabilities.loans.reduce((sum, item) => sum + item.amount, 0);
            const totalLiabilities = totalCreditCards + totalLoans;

            const netWorth = totalAssets - totalLiabilities;

            const totalIncome = cashFlow.income.reduce((sum, item) => sum + item.amount, 0);
            const totalExpenses = cashFlow.expenses.reduce((sum, item) => sum + item.amount, 0);
            const monthlyNet = totalIncome - totalExpenses;

            const emergencyFundMonths = totalExpenses > 0 ? (totalCash / totalExpenses).toFixed(1) : 0;
            const debtToIncomeRatio = totalIncome > 0 ? (totalLoans / totalIncome * 100).toFixed(1) : 0;
            const savingsRate = totalIncome > 0 ? (monthlyNet / totalIncome * 100).toFixed(1) : 0;
            const investmentRatio = totalAssets > 0 ? (totalInvestments / totalAssets * 100).toFixed(1) : 0;

            return {
              totalCash, twStockTotal, usStockTotalUSD, usStockTotalTWD, etfTotal, insuranceTotalTWD, totalFixedAssets, insuranceAndFixedTotalTWD,
              totalInvestments, totalAssets, totalCreditCards, totalLoans, totalLiabilities, netWorth,
              totalIncome, totalExpenses, monthlyNet,
              emergencyFundMonths, debtToIncomeRatio, savingsRate, investmentRatio
            };
          }, [assets, liabilities, cashFlow, usdRate]);

          // --- 格式化工具 ---
          const formatCurrency = (val) => new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(val);
          const formatUSD = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 2 }).format(val);

          // --- 顧問行動計畫 ---
          const actionPlans = useMemo(() => {
            const plans = [];
            if (calculations.totalCreditCards > 0) {
              plans.push({ title: "優先清理高息債務", desc: `信用卡未繳金額為 ${formatCurrency(calculations.totalCreditCards)}。信用卡利息極高，請立即結清。` });
            }
            if (calculations.monthlyNet < 0) {
              plans.push({ title: "調整收支平衡", desc: `每月支出超出收入 ${formatCurrency(Math.abs(calculations.monthlyNet))}。建議檢視支出項目。` });
            } else {
                if (calculations.emergencyFundMonths < 6) {
                    plans.push({ title: "補足緊急預備金", desc: `目前現金可支撐 ${calculations.emergencyFundMonths} 個月生活，建議目標存滿 6 個月。` });
                } else {
                    plans.push({ title: "優化資產配置", desc: "預備金已充足，建議優化投資組合增加被動收入。" });
                }
            }
            return plans;
          }, [calculations]);

          // --- 檔案匯出匯入 ---
          const showToast = (text, type = 'success') => { setToastMessage({ text, type }); setTimeout(() => setToastMessage(null), 3000); };
          const handleExport = () => {
            const data = { usdRate, assets, liabilities, cashFlow };
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data, null, 2));
            const dl = document.createElement('a');
            dl.setAttribute("href", dataStr);
            dl.setAttribute("download", `理財健檢_${new Date().toISOString().slice(0,10)}.json`);
            dl.click();
            showToast("備份匯出成功！");
          };
          const handleImport = (event) => {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
              try {
                const p = JSON.parse(e.target.result);
                if (p.assets) setAssets(p.assets); if (p.liabilities) setLiabilities(p.liabilities); 
                if (p.cashFlow) setCashFlow(p.cashFlow); if (p.usdRate) setUsdRate(p.usdRate);
                showToast("資料匯入成功！");
              } catch (err) { showToast("匯入失敗，請確認檔案格式", "error"); }
            };
            reader.readAsText(file);
          };

          // --- 股價同步 ---
          const handleSyncPrices = async () => {
            setIsSyncing(true);
            const fetchFromYahoo = async (ticker) => {
                try {
                    const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1d&range=1d`)}`);
                    const d = JSON.parse((await res.json()).contents);
                    return d.chart?.result?.[0]?.meta?.regularMarketPrice || null;
                } catch { return null; }
            };
            const fetchPrice = async (item, isTw) => {
                let ticker = (item.ticker || '').trim().toUpperCase();
                if (!ticker && /^[A-Z0-9.]+$/i.test(item.name.trim())) ticker = item.name.trim().toUpperCase();
                if (!ticker) return item;
                if (isTw && /^\d+$/.test(ticker)) {
                    let price = await fetchFromYahoo(`${ticker}.TW`);
                    if (!price) price = await fetchFromYahoo(`${ticker}.TWO`);
                    return price ? { ...item, price: Number(price.toFixed(2)) } : item;
                } else {
                    const price = await fetchFromYahoo(ticker);
                    return price ? { ...item, price: Number(price.toFixed(2)) } : item;
                }
            };
            const [tw, etfs, us] = await Promise.all([
                Promise.all(assets.twStocks.map(i => fetchPrice(i, true))),
                Promise.all(assets.etfs.map(i => fetchPrice(i, true))),
                Promise.all(assets.usStocks.map(i => fetchPrice(i, false)))
            ]);
            setAssets(prev => ({ ...prev, twStocks: tw, etfs, usStocks: us }));
            setIsSyncing(false);
            showToast("股價更新完成！");
          };

          // --- 通用狀態處理 ---
          const handleItemChange = (cat, list, id, field, val) => {
            const update = p => ({ ...p, [list]: p[list].map(i => i.id === id ? { ...i, [field]: (field==='name'||field==='currency'||field==='ticker'? val : Number(val)||0) } : i) });
            if (cat==='assets') setAssets(update); else if (cat==='liabilities') setLiabilities(update); else setCashFlow(update);
          };
          const handleAddItem = (cat, list, def) => {
            const update = p => ({ ...p, [list]: [...p[list], { ...def, id: Date.now()+Math.random() }] });
            if (cat==='assets') setAssets(update); else if (cat==='liabilities') setLiabilities(update); else setCashFlow(update);
          };
          const handleRemoveItem = (cat, list, id) => {
            const update = p => ({ ...p, [list]: p[list].filter(i => i.id !== id) });
            if (cat==='assets') setAssets(update); else if (cat==='liabilities') setLiabilities(update); else setCashFlow(update);
          };
          const handleMoveItem = (cat, list, idx, dir) => {
            const update = p => {
                const newList = [...p[list]];
                const target = dir === 'up' ? idx - 1 : idx + 1;
                if (target < 0 || target >= newList.length) return p;
                [newList[idx], newList[target]] = [newList[target], newList[idx]];
                return { ...p, [list]: newList };
            };
            if (cat==='assets') setAssets(update); else if (cat==='liabilities') setLiabilities(update); else setCashFlow(update);
          };

          const TabButton = ({ id, label, icon: Icon }) => (
            <button onClick={() => setActiveTab(id)} className={`flex items-center gap-2 px-4 py-3 font-medium transition-all border-b-2 ${activeTab === id ? 'border-blue-600 text-blue-700 bg-blue-50' : 'border-transparent text-gray-500 hover:text-gray-700'}`}>
              <Icon size={18} /><span>{label}</span>
            </button>
          );

          return (
            <div className="min-h-screen text-gray-800 p-4 md:p-8 bg-gray-100">
              {toastMessage && (
                <div className={`fixed top-4 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-lg shadow-lg font-medium text-sm flex items-center gap-2 ${toastMessage.type === 'success' ? 'bg-green-600 text-white' : 'bg-red-600 text-white'}`}>
                  {toastMessage.text}
                </div>
              )}
              
              <div className="max-w-6xl mx-auto space-y-6">
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 bg-white p-6 rounded-2xl shadow-sm">
                  <div>
                    <div className="flex items-center gap-3">
                      <h1 className="text-2xl font-bold text-gray-900">理財健檢小秘書</h1>
                      <span className="text-xs text-green-700 bg-green-100 px-2 py-1 rounded-full flex items-center gap-1 font-medium"><IconSave size={12}/> 已自動本機存檔</span>
                    </div>
                    <p className="text-gray-500 text-sm mt-1">財務顧問專業分析版</p>
                  </div>
                  <div className="flex flex-col items-end gap-2 w-full md:w-auto">
                    <div className="flex items-center gap-2 bg-blue-50 px-3 py-1.5 rounded-lg border border-blue-100 text-sm w-full md:w-auto">
                      <IconDollarSign size={16} className="text-blue-600" />
                      <span>匯率 (USD/TWD):</span>
                      <input type="number" value={usdRate} onChange={e => setUsdRate(Number(e.target.value)||0)} className="w-16 px-1 border rounded bg-white text-right font-medium" />
                    </div>
                    <div className="flex gap-2 w-full md:w-auto">
                      <button onClick={handleExport} className="flex-1 text-xs bg-white border px-3 py-1.5 rounded-lg hover:bg-gray-50 flex items-center justify-center gap-1"><IconDownload size={14}/> 匯出備份</button>
                      <button onClick={() => fileInputRef.current.click()} className="flex-1 text-xs bg-white border px-3 py-1.5 rounded-lg hover:bg-gray-50 flex items-center justify-center gap-1"><IconUpload size={14}/> 匯入資料</button>
                      <input type="file" accept=".json" ref={fileInputRef} onChange={handleImport} className="hidden" />
                    </div>
                  </div>
                </div>

                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div className="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-blue-500">
                        <p className="text-xs font-medium text-gray-500 mb-1">總資產</p>
                        <p className="text-xl font-bold text-gray-900">{formatCurrency(calculations.totalAssets)}</p>
                    </div>
                    <div className="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-red-500">
                        <p className="text-xs font-medium text-gray-500 mb-1">總負債</p>
                        <p className="text-xl font-bold text-gray-900">{formatCurrency(calculations.totalLiabilities)}</p>
                    </div>
                    <div className="bg-white p-5 rounded-2xl shadow-sm border-l-4 border-purple-500">
                        <p className="text-xs font-medium text-gray-500 mb-1">淨資產 (財富淨值)</p>
                        <p className={`text-xl font-bold ${calculations.netWorth >= 0 ? 'text-purple-700' : 'text-red-600'}`}>{formatCurrency(calculations.netWorth)}</p>
                    </div>
                    <div className={`bg-white p-5 rounded-2xl shadow-sm border-l-4 ${calculations.monthlyNet >= 0 ? 'border-green-500' : 'border-red-500'}`}>
                        <p className="text-xs font-medium text-gray-500 mb-1">每月結餘</p>
                        <p className={`text-xl font-bold ${calculations.monthlyNet >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(calculations.monthlyNet)}</p>
                    </div>
                </div>

                <div className="bg-white rounded-2xl shadow-sm overflow-hidden border border-gray-200">
                    <div className="flex border-b overflow-x-auto">
                        <TabButton id="dashboard" label="綜合看板" icon={IconPieChart} />
                        <TabButton id="assets" label="資產明細" icon={IconWallet} />
                        <TabButton id="liabilities" label="負債明細" icon={IconTrendingDown} />
                        <TabButton id="cashflow" label="現金收支" icon={IconTrendingUp} />
                    </div>

                    <div className="p-6">
                        {activeTab === 'dashboard' && (
                            <div className="space-y-8 animate-in fade-in duration-300">
                                <section>
                                    <h3 className="text-lg font-bold mb-4 flex items-center gap-2"><IconActivity className="text-blue-500"/> 財務健康度儀表板</h3>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                        <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 text-center">
                                            <p className="text-xs text-gray-500">預備金月數</p>
                                            <p className="text-2xl font-bold text-gray-800 mt-1">{calculations.emergencyFundMonths} 個月</p>
                                            <div className="w-full bg-gray-200 h-1.5 rounded-full mt-2">
                                                <div className={`h-1.5 rounded-full progress-bar ${calculations.emergencyFundMonths >= 6 ? 'bg-green-500' : 'bg-yellow-500'}`} style={{ width: `${Math.min(calculations.emergencyFundMonths * 16.6, 100)}%` }}></div>
                                            </div>
                                        </div>
                                        <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 text-center">
                                            <p className="text-xs text-gray-500">儲蓄率</p>
                                            <p className="text-2xl font-bold text-gray-800 mt-1">{calculations.savingsRate}%</p>
                                            <div className="w-full bg-gray-200 h-1.5 rounded-full mt-2">
                                                <div className={`h-1.5 rounded-full progress-bar ${calculations.savingsRate >= 20 ? 'bg-green-500' : 'bg-red-500'}`} style={{ width: `${Math.max(0, Math.min(calculations.savingsRate, 100))}%` }}></div>
                                            </div>
                                        </div>
                                        <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 text-center">
                                            <p className="text-xs text-gray-500">負債負擔比</p>
                                            <p className="text-2xl font-bold text-gray-800 mt-1">{calculations.debtToIncomeRatio}%</p>
                                            <div className="w-full bg-gray-200 h-1.5 rounded-full mt-2">
                                                <div className={`h-1.5 rounded-full progress-bar ${calculations.debtToIncomeRatio <= 30 ? 'bg-green-500' : 'bg-red-500'}`} style={{ width: `${Math.min(calculations.debtToIncomeRatio, 100)}%` }}></div>
                                            </div>
                                        </div>
                                        <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 text-center">
                                            <p className="text-xs text-gray-500">投資佔比</p>
                                            <p className="text-2xl font-bold text-gray-800 mt-1">{calculations.investmentRatio}%</p>
                                            <div className="w-full bg-gray-200 h-1.5 rounded-full mt-2 flex">
                                                <div style={{ width: `${calculations.investmentRatio}%` }} className="h-full bg-blue-500"></div>
                                                <div style={{ width: `${100-calculations.investmentRatio}%` }} className="h-full bg-orange-300"></div>
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div className="bg-amber-50 p-6 rounded-xl border border-amber-200">
                                        <h3 className="font-bold text-amber-900 mb-4 flex items-center gap-2"><IconAlertTriangle size={18}/> 顧問診斷</h3>
                                        <ul className="space-y-3 text-sm text-amber-800">
                                            <li className="flex items-center gap-2">
                                                {calculations.totalCreditCards === 0 ? <IconCheckCircle size={16} className="text-green-600"/> : <IconAlertTriangle size={16} className="text-red-600"/>}
                                                {calculations.totalCreditCards === 0 ? "無信用卡欠款，信用良好。" : `有 ${formatCurrency(calculations.totalCreditCards)} 的信用卡欠款，請優先處理。`}
                                            </li>
                                            <li className="flex items-center gap-2">
                                                {calculations.emergencyFundMonths >= 6 ? <IconCheckCircle size={16} className="text-green-600"/> : <IconAlertTriangle size={16} className="text-yellow-600"/>}
                                                {calculations.emergencyFundMonths >= 6 ? "預備金充足，可承擔 6 個月以上支出。" : "預備金水位不足 6 個月，建議先存錢。"}
                                            </li>
                                        </ul>
                                    </div>
                                    <div className="bg-green-50 p-6 rounded-xl border border-green-200">
                                        <h3 className="font-bold text-green-900 mb-4 flex items-center gap-2"><IconTrendingUp size={18}/> 理財行動建議</h3>
                                        <ol className="space-y-3">
                                            {actionPlans.map((plan, i) => (
                                                <li key={i} className="flex gap-2 text-sm text-green-800">
                                                    <span className="font-bold">{i+1}.</span>
                                                    <div><strong>{plan.title}</strong>：{plan.desc}</div>
                                                </li>
                                            ))}
                                        </ol>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'assets' && (
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 animate-in fade-in duration-300">
                                <div className="space-y-6">
                                    <div className="bg-gray-50 p-5 rounded-xl border border-gray-200">
                                        <div className="flex justify-between items-center mb-4">
                                            <h4 className="font-bold">現金帳戶 <span className="text-xs font-normal text-gray-500">({formatCurrency(calculations.totalCash)})</span></h4>
                                            <button onClick={() => handleAddItem('assets', 'cashAccounts', { name: '', amount: 0 })} className="text-blue-600 text-xs flex items-center gap-1"><IconPlus size={12}/>新增</button>
                                        </div>
                                        <div className="space-y-2">
                                            {assets.cashAccounts.map((item, idx) => (
                                                <div key={item.id} className="flex items-center gap-2 bg-white p-2 rounded border focus-within:ring-1 focus-within:ring-blue-500">
                                                    <input type="text" value={item.name} onChange={e => handleItemChange('assets', 'cashAccounts', item.id, 'name', e.target.value)} className="flex-1 bg-transparent text-sm font-medium outline-none" placeholder="帳戶名稱" />
                                                    <input type="number" value={item.amount} onChange={e => handleItemChange('assets', 'cashAccounts', item.id, 'amount', e.target.value)} className="w-24 text-right text-sm font-bold outline-none" />
                                                    <button onClick={() => handleRemoveItem('assets', 'cashAccounts', item.id)} disabled={assets.cashAccounts.length<=1} className="text-gray-300 hover:text-red-500"><IconTrash size={14}/></button>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* 修正：保險與固定資產 UI 顯示 */}
                                    <div className="bg-gray-50 p-5 rounded-xl border border-gray-200">
                                        <div className="flex justify-between items-center mb-4">
                                            <h4 className="font-bold">保險與固定資產 <span className="text-xs font-normal text-gray-500">({formatCurrency(calculations.insuranceAndFixedTotalTWD)})</span></h4>
                                        </div>
                                        <div className="space-y-6">
                                            <div>
                                                <div className="flex justify-between items-center mb-2">
                                                    <p className="text-xs text-gray-500 font-bold">現價保單 <span className="font-normal opacity-70">({formatCurrency(calculations.insuranceTotalTWD)})</span></p>
                                                    <button onClick={() => handleAddItem('assets', 'insurances', { name: '', amount: 0, currency: 'TWD' })} className="text-blue-600 text-[10px]">+新增</button>
                                                </div>
                                                <div className="space-y-2">
                                                    {assets.insurances.map(item => (
                                                        <div key={item.id} className="flex items-center gap-2 bg-white p-2 rounded border text-sm">
                                                            <input type="text" value={item.name} onChange={e => handleItemChange('assets', 'insurances', item.id, 'name', e.target.value)} className="flex-1 bg-transparent font-medium outline-none" placeholder="名稱" />
                                                            <select value={item.currency} onChange={e => handleItemChange('assets', 'insurances', item.id, 'currency', e.target.value)} className="text-[10px] border rounded p-1 outline-none">
                                                                <option value="TWD">TWD</option><option value="USD">USD</option>
                                                            </select>
                                                            <input type="number" value={item.amount} onChange={e => handleItemChange('assets', 'insurances', item.id, 'amount', e.target.value)} className="w-20 text-right font-bold outline-none" />
                                                            <button onClick={() => handleRemoveItem('assets', 'insurances', item.id)} className="text-gray-300 hover:text-red-500"><IconTrash size={14}/></button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                            <div>
                                                <div className="flex justify-between items-center mb-2">
                                                    <p className="text-xs text-gray-500 font-bold">固定資產 <span className="font-normal opacity-70">({formatCurrency(calculations.totalFixedAssets)})</span></p>
                                                    <button onClick={() => handleAddItem('assets', 'fixedAssetsList', { name: '', amount: 0 })} className="text-blue-600 text-[10px]">+新增</button>
                                                </div>
                                                <div className="space-y-2">
                                                    {assets.fixedAssetsList.map(item => (
                                                        <div key={item.id} className="flex items-center gap-2 bg-white p-2 rounded border text-sm">
                                                            <input type="text" value={item.name} onChange={e => handleItemChange('assets', 'fixedAssetsList', item.id, 'name', e.target.value)} className="flex-1 bg-transparent font-medium outline-none" placeholder="項目" />
                                                            <input type="number" value={item.amount} onChange={e => handleItemChange('assets', 'fixedAssetsList', item.id, 'amount', e.target.value)} className="w-24 text-right font-bold outline-none" />
                                                            <button onClick={() => handleRemoveItem('assets', 'fixedAssetsList', item.id)} className="text-gray-300 hover:text-red-500"><IconTrash size={14}/></button>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div className="space-y-6">
                                    <div className="bg-blue-50 p-5 rounded-xl border border-blue-100">
                                        <div className="flex justify-between items-center mb-4">
                                            <h4 className="font-bold flex items-center gap-2">投資部位 <button onClick={handleSyncPrices} disabled={isSyncing} className={`text-[10px] px-2 py-1 rounded bg-blue-600 text-white flex items-center gap-1 ${isSyncing ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-700'}`}>{isSyncing ? <IconRefreshCw size={10} className="sync-loading"/> : <IconRefreshCw size={10}/>} 一鍵同步</button></h4>
                                            <span className="text-xs font-bold text-blue-700">總計: {formatCurrency(calculations.totalInvestments)}</span>
                                        </div>
                                        <div className="space-y-6">
                                            {[{ label: '台股', list: 'twStocks',小計: calculations.twStockTotal, def: '2330' }, { label: 'ETF', list: 'etfs', 小計: calculations.etfTotal, def: '0050' }, { label: '美股', list: 'usStocks', 小計: calculations.usStockTotalTWD, def: 'AAPL', unit: '$' }].map(block => (
                                                <div key={block.list}>
                                                    <div className="flex justify-between items-center border-b pb-1 mb-2">
                                                        <p className="text-xs text-gray-500 font-bold">{block.label} <span className="font-normal">(小計: {formatCurrency(block.小計)})</span></p>
                                                        <button onClick={() => handleAddItem('assets', block.list, { name: '', ticker: '', shares: 0, price: 0 })} className="text-blue-600 text-[10px]">+新增</button>
                                                    </div>
                                                    <div className="space-y-2">
                                                        {assets[block.list].map((item, idx) => (
                                                            <div key={item.id} className="bg-white p-2 rounded border text-xs shadow-sm space-y-1">
                                                                <div className="flex gap-2">
                                                                    <input type="text" value={item.name} onChange={e=>handleItemChange('assets', block.list, item.id, 'name', e.target.value)} className="font-bold w-1/2 outline-none border-b border-transparent focus:border-blue-200" placeholder="名稱"/>
                                                                    <input type="text" value={item.ticker} onChange={e=>handleItemChange('assets', block.list, item.id, 'ticker', e.target.value)} className="w-1/2 text-blue-600 font-mono outline-none border-b border-transparent focus:border-blue-200" placeholder={`代號(${block.def})`}/>
                                                                    <button onClick={() => handleRemoveItem('assets', block.list, item.id)} className="text-gray-300 hover:text-red-500"><IconTrash size={12}/></button>
                                                                </div>
                                                                <div className="flex items-center gap-1 text-gray-500">
                                                                    <input type="number" value={item.shares} onChange={e=>handleItemChange('assets', block.list, item.id, 'shares', e.target.value)} className="w-14 border rounded text-right px-1" /><span>股 ×</span>
                                                                    <input type="number" value={item.price} onChange={e=>handleItemChange('assets', block.list, item.id, 'price', e.target.value)} className="w-14 border rounded text-right px-1" step="0.01" /><span>{block.unit || '元'}</span>
                                                                    <span className="ml-auto font-bold text-gray-800">{block.unit==='$' ? formatUSD(item.shares*item.price) : formatCurrency(item.shares*item.price)}</span>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'liabilities' && (
                            <div className="max-w-4xl mx-auto space-y-6 animate-in fade-in duration-300">
                                <div className="bg-red-50 p-6 rounded-2xl border border-red-100">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                        <div>
                                            <div className="flex justify-between items-center mb-4 border-b border-red-200 pb-2 font-bold text-red-800">
                                                <span>信用卡項目</span><button onClick={() => handleAddItem('liabilities', 'creditCards', { name: '', amount: 0 })} className="text-[10px] bg-white px-2 py-1 rounded">+新增</button>
                                            </div>
                                            <div className="space-y-2">
                                                {liabilities.creditCards.map(item => (
                                                    <div key={item.id} className="flex items-center gap-2 bg-white p-2 rounded border text-sm">
                                                        <input type="text" value={item.name} onChange={e => handleItemChange('liabilities', 'creditCards', item.id, 'name', e.target.value)} className="flex-1 outline-none" placeholder="項目" />
                                                        <input type="number" value={item.amount} onChange={e => handleItemChange('liabilities', 'creditCards', item.id, 'amount', e.target.value)} className="w-20 text-right font-bold text-red-600 outline-none" />
                                                        <button onClick={() => handleRemoveItem('liabilities', 'creditCards', item.id)} className="text-gray-300 hover:text-red-500"><IconTrash size={14}/></button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div>
                                            <div className="flex justify-between items-center mb-4 border-b border-red-200 pb-2 font-bold text-red-800">
                                                <span>貸款項目</span><button onClick={() => handleAddItem('liabilities', 'loans', { name: '', amount: 0 })} className="text-[10px] bg-white px-2 py-1 rounded">+新增</button>
                                            </div>
                                            <div className="space-y-2">
                                                {liabilities.loans.map(item => (
                                                    <div key={item.id} className="flex items-center gap-2 bg-white p-2 rounded border text-sm">
                                                        <input type="text" value={item.name} onChange={e => handleItemChange('liabilities', 'loans', item.id, 'name', e.target.value)} className="flex-1 outline-none" placeholder="項目" />
                                                        <input type="number" value={item.amount} onChange={e => handleItemChange('liabilities', 'loans', item.id, 'amount', e.target.value)} className="w-20 text-right font-bold outline-none" />
                                                        <button onClick={() => handleRemoveItem('liabilities', 'loans', item.id)} className="text-gray-300 hover:text-red-500"><IconTrash size={14}/></button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                    <div className="mt-8 pt-6 border-t border-red-200 text-right">
                                        <p className="text-sm text-red-500 font-medium">總負債: <span className="text-2xl font-black">{formatCurrency(calculations.totalLiabilities)}</span></p>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'cashflow' && (
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 animate-in fade-in duration-300">
                                <div className="bg-green-50 p-6 rounded-2xl border border-green-100">
                                    <div className="flex justify-between items-center mb-4 border-b border-green-200 pb-2 font-bold text-green-900">
                                        <span>月收入項目</span><button onClick={() => handleAddItem('cashFlow', 'income', { name: '', amount: 0 })} className="text-[10px] bg-white px-2 py-1 rounded">+新增</button>
                                    </div>
                                    <div className="space-y-2">
                                        {cashFlow.income.map(item => (
                                            <div key={item.id} className="flex items-center gap-2 bg-white p-2 rounded border text-sm">
                                                <input type="text" value={item.name} onChange={e => handleItemChange('cashFlow', 'income', item.id, 'name', e.target.value)} className="flex-1 outline-none font-medium" placeholder="來源" />
                                                <input type="number" value={item.amount} onChange={e => handleItemChange('cashFlow', 'income', item.id, 'amount', e.target.value)} className="w-20 text-right font-black text-green-700 outline-none" />
                                                <button onClick={() => handleRemoveItem('cashFlow', 'income', item.id)} className="text-gray-300 hover:text-red-500"><IconTrash size={14}/></button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                                <div className="bg-orange-50 p-6 rounded-2xl border border-orange-100">
                                    <div className="flex justify-between items-center mb-4 border-b border-orange-200 pb-2 font-bold text-orange-900">
                                        <span>月支出項目</span><button onClick={() => handleAddItem('cashFlow', 'expenses', { name: '', amount: 0 })} className="text-[10px] bg-white px-2 py-1 rounded">+新增</button>
                                    </div>
                                    <div className="space-y-2 max-h-[400px] overflow-y-auto">
                                        {cashFlow.expenses.map(item => (
                                            <div key={item.id} className="flex items-center gap-2 bg-white p-2 rounded border text-sm">
                                                <input type="text" value={item.name} onChange={e => handleItemChange('cashFlow', 'expenses', item.id, 'name', e.target.value)} className="flex-1 outline-none" placeholder="項目" />
                                                <input type="number" value={item.amount} onChange={e => handleItemChange('cashFlow', 'expenses', item.id, 'amount', e.target.value)} className="w-20 text-right font-bold text-orange-700 outline-none" />
                                                <button onClick={() => handleRemoveItem('cashFlow', 'expenses', item.id)} className="text-gray-300 hover:text-red-500"><IconTrash size={14}/></button>
                                            </div>
                                        ))}
                                    </div>
                                    <div className={`mt-6 p-4 rounded-xl border flex items-center justify-between ${calculations.monthlyNet >= 0 ? 'bg-green-100 text-green-800 border-green-200' : 'bg-red-100 text-red-800 border-red-200'}`}>
                                        <span className="font-bold text-sm">每月結餘</span>
                                        <span className="text-xl font-black">{formatCurrency(calculations.monthlyNet)}</span>
                                    </div>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
              </div>
            </div>
          );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<FinancialPlanner />);
    </script>
</body>
</html>
